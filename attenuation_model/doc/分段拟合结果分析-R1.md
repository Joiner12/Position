# 分段拟合

## 1、对数路径损耗模型

​	现有室内蓝牙定位（**Indoor BlueTooth Location**）方案是基于接收信号强度指示RSSI的多点定位方法 。**RSSI**测距的基本原理：无线信号传输中，信号强度随距离变化呈一定规律的衰减（**对数路径损耗模型**），根据采样信号构建路径衰减数学模型，然后将测量过程中的**RSSI**转换成距离最终计算测量点的位置。

对数路径损耗模型：
$$
\begin{align}
& \bold{Pl(d) = Pl(d_0) + 10nlg(d/d_0) + X_{\delta}}\\
\end{align}
$$
$Pl(d)$ ：未知节点在距离为d时对应的接收信号功率(dBm)；

$X_{\delta}$ ： 标准偏差为$\delta$的正态随机变量，$\delta $的取值与信号跳变过程相关；

不考虑信号跳变量$X_{\delta}$，通过上述公式可得：
$$
\begin{align}
&\bold{p(d)=A-10blg(d)} \\
\end{align}
$$

$$
\begin{align}
&\bold{d_1 = {\frac{A - RSSI}{10*b}}}\\
& \bold{d = 10^{d_1}}
\end{align}
$$




$A(A < 0)$：距离1m时，设备接收到无线信号的RSSI值；

$b(b>0)$：衰减系数；

$d(d>0)$：解算距离(m)；

$RSSI(RSSI<0)$ ：rssi观测值(db)；

## 2、分段拟合

​	从实验中发现，如果采用单一对数路径损耗模型存在以下不足：（1）以全局最优为拟合方式和拟合目标，得到的对数路径损耗模型中${n}$值偏小，当${RSSI}$ 值较小的情况下，解算出来的距离会偏大很多。（2）当${n}$值偏大的情况下，${RSSI}$较大的情况下，误差偏大。

​	为了解决上述问题，依据$RSSI$值将曲线分为两部分单独进行拟合，$pd_1(RSSI < RSSI_c)$ 和 ${pd_2(RSSI \geq const(RSSI_c)  )}$ 两个函数。拟合完成之后，将${pd_1 =pd_2}$ 对应的${RSSI_i}$ 作为后续解算分段的依据。

```c
todo: figure 
```

## 3、分段拟合结果

​	在较为理想的情况下，测试RSSI和距离对应数据，并根据测试结果对8个锚节点（anchor）特征分别进行分段拟合。拟合结果如下：

### 3.1 one_pos_HLK_1

![](../figure/one_pos_HLK_1分段拟合结果-1.png)

rssi >= -50拟合结果:A=-46.44,n=0.36
     General model:
     fitresult_1(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -46.44  (-60.94, -31.94)
       b =      0.3551  (-1.296, 2.006)
rssi < -50拟合结果:A=-31.03,n=2.42
     General model:
     fitresult_2(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -31.03  (-45.54, -16.52)
       b =       2.424  (1.105, 3.743)
分段曲线交点RSSI:-49.08

```matlab
 AP_1 =  struct('Name','onepos_HLK_1',...
     'param_less_rssi',[-31.03,2.424],...
     'param_more_rssi',[-46.44,0.3551],...
     'piecewise_rssi', -49.08);
```



___________________
 ### 3.2 one_pos_HLK_2

![](../figure/one_pos_HLK_2分段拟合结果-1.png)

rssi >= -52拟合结果:A=-44.25,n=0.86
     General model:
     fitresult_1(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -44.25  (-56.21, -32.28)
       b =      0.8552  (-0.6993, 2.41)
rssi < -52拟合结果:A=-24.65,n=3.02
     General model:
     fitresult_2(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -24.65  (-56.66, 7.355)
       b =       3.018  (0.09569, 5.94)
分段曲线交点RSSI:-52.00

```matlab
AP_2 =  struct('Name','onepos_HLK_2',...
    'param_less_rssi',[-24.65,3.018],...
    'param_more_rssi',[ -44.25 ,0.8552],...
    'piecewise_rssi', -52);
```



___________________
 ### 3.3 one_pos_HLK_3

![](../figure/one_pos_HLK_3分段拟合结果-1.png)

rssi >= -51拟合结果:A=-44.78,n=0.75
     General model:
     fitresult_1(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -44.78  (-51.35, -38.21)
       b =      0.7517  (-0.07243, 1.576)
rssi < -51拟合结果:A=-26.35,n=2.86
     General model:
     fitresult_2(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -26.35  (-56.6, 3.894)
       b =       2.865  (0.1043, 5.625)
分段曲线交点RSSI:-51.33

```matlab
AP_3 =  struct('Name','onepos_HLK_3',...
    'param_less_rssi',[-26.35,2.86],...
    'param_more_rssi',[-44.78,0.75],...
    'piecewise_rssi', -51.33);
```



___________________
 ### 3.4 one_pos_HLK_4

![](../figure/one_pos_HLK_4分段拟合结果-1.png)

rssi >= -53拟合结果:A=-46.49,n=0.80
     General model:
     fitresult_1(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -46.49  (-55.23, -37.75)
       b =      0.7952  (-0.2551, 1.845)
rssi < -53拟合结果:A=-36.49,n=2.16
     General model:
     fitresult_2(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -36.49  (-55.77, -17.2)
       b =       2.161  (0.3905, 3.931)
分段曲线交点RSSI:-52.32

```matlab
AP_4 =  struct('Name','onepos_HLK_4',...
    'param_less_rssi',[-36.49,2.16],...
    'param_more_rssi',[-46.49,0.80],...
    'piecewise_rssi', -52.32);

```



___________________
 ### 3.5 one_pos_HLK_5

![](../figure/one_pos_HLK_5分段拟合结果-1.png)

rssi >= -53拟合结果:A=-44.01,n=1.02
     General model:
     fitresult_1(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -44.01  (-48.05, -39.98)
       b =       1.015  (0.5313, 1.499)
rssi < -53拟合结果:A=-30.28,n=2.78
     General model:
     fitresult_2(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -30.28  (-49.54, -11.03)
       b =       2.777  (1.034, 4.52)
分段曲线交点RSSI:-51.93

```matlab
AP_5 =  struct('Name','onepos_HLK_5',...
    'param_less_rssi',[-30.28,2.78],...
    'param_more_rssi',[-44.01,1.02],...
    'piecewise_rssi', -51.93);

```



___________________
 ### 3.6 one_pos_HLK_6

![](../figure/one_pos_HLK_6分段拟合结果-1.png)

rssi >= -59拟合结果:A=-45.45,n=1.71
     General model:
     fitresult_1(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -45.45  (-68.74, -22.15)
       b =       1.707  (-1.589, 5.003)
rssi < -59拟合结果:A=-6.33,n=5.36
     General model:
     fitresult_2(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -6.327  (-87.73, 75.08)
       b =       5.365  (-2.017, 12.75)
分段曲线交点RSSI:-63.70

```matlab
AP_6 =  struct('Name','onepos_HLK_6',...
    'param_less_rssi',[-6.33,5.36],...
    'param_more_rssi',[-45.45,1.71],...
    'piecewise_rssi', -63.70);
```



___________________
 ### 3.7 one_pos_HLK_7

![](../figure/one_pos_HLK_7分段拟合结果-1.png)

rssi >= -62拟合结果:A=-44.91,n=1.61
     General model:
     fitresult_1(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -44.91  (-59.68, -30.15)
       b =       1.607  (0.06736, 3.147)
rssi < -62拟合结果:A=-8.61,n=5.11
     General model:
     fitresult_2(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -8.611  (-196.9, 179.7)
       b =       5.111  (-11.49, 21.71)
分段曲线交点RSSI:-61.56

```matlab
AP_7 =  struct('Name','onepos_HLK_7',...
    'param_less_rssi',[-8.61,5.11],...
    'param_more_rssi',[-44.91,1.61],...
    'piecewise_rssi', -61.56);
```



___________________
 ### 3.8 one_pos_HLK_8

![](../figure/one_pos_HLK_8分段拟合结果-1.png)

rssi >= -53拟合结果:A=-42.33,n=1.09
     General model:
     fitresult_1(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =      -42.33  (-47.12, -37.55)
       b =       1.091  (0.509, 1.673)
rssi < -53拟合结果:A=35.78,n=8.31
     General model:
     fitresult_2(x) = power(10,(a-x)/10/b)
     Coefficients (with 95% confidence bounds):
       a =       35.78  (-205.9, 277.5)
       b =       8.315  (-13.12, 29.74)
分段曲线交点RSSI:-54.13

```matlab
AP_8 =  struct('Name','onepos_HLK_8',...
    'param_less_rssi',[35.78,8.315],...
    'param_more_rssi',[-42.33,1.09],...
    'piecewise_rssi', -54.13);
```



___________________



